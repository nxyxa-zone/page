<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator LKPD & Portofolio PJOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
        }

        .signature-pad {
            touch-action: none;
            cursor: crosshair;
            background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2394a3b8' fill-opacity='0.2' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3C/g%3E%3C/svg%3E");
        }

        .identity-grid {
            display: grid;
            grid-template-columns: 140px 10px 1fr;
            align-items: center;
            row-gap: 0.75rem;
        }

        .custom-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #334155;
            border-radius: 4px;
            cursor: pointer;
            accent-color: #000;
        }

        /* Helper class untuk sembunyikan elemen saat mode siswa */
        .teacher-only-active {
            pointer-events: none;
            opacity: 0.6;
        }

        @media print {
            @page { margin: 0; size: auto; }
            body { background: white; padding: 0; margin: 0; }
            .container { max-width: 100% !important; width: 100% !important; padding: 20px !important; }
            .no-print { display: none !important; }
            .main-card { box-shadow: none !important; border: none !important; border-radius: 0; }
            input, textarea, select { 
                border: none !important; 
                border-bottom: 1px solid #94a3b8 !important; 
                background: transparent !important; 
                padding-left: 0 !important;
                resize: none;
                -webkit-appearance: none;
                appearance: none;
            }
            ::placeholder { color: transparent; }
            /* Hide empty elements in print */
            #student-catatan:empty { display: none; }
            .page-break { page-break-before: always; }
            .avoid-break { page-break-inside: avoid; }
            
            /* Pastikan input nilai terlihat jelas saat diprint */
            #student-nilai, #student-predikat { font-weight: bold; color: black; }
        }
    </style>
    
    <!-- CRITICAL UI SCRIPTS -->
    <script>
        const TEACHER_PIN = "270302";

        window.openLoginModal = function() {
            document.getElementById('login-modal').classList.remove('hidden');
            const pinInput = document.getElementById('pin-input');
            pinInput.value = "";
            pinInput.disabled = false;
            setTimeout(() => pinInput.focus(), 100);
        }

        window.closeLoginModal = function() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        window.checkPin = function() {
            const input = document.getElementById('pin-input').value;
            if (input === TEACHER_PIN) {
                // 1. Buka Panel Dashboard
                const panel = document.getElementById('teacher-panel');
                const btn = document.getElementById('btn-login');
                closeLoginModal();
                panel.classList.remove('hidden');
                btn.classList.add('hidden');
                
                // 2. BUKA AKSES NILAI & TTD DI HALAMAN UTAMA (UNLOCK)
                unlockGradingSection();

                window.scrollTo({ top: 0, behavior: 'smooth' });
                alert("Mode Guru Aktif: Anda sekarang bisa mengisi Nilai dan Tanda Tangan langsung di form.");
            } else {
                alert("PIN Salah! Coba lagi.");
                document.getElementById('pin-input').value = "";
            }
        }

        // Fungsi Membuka Kunci Bagian Penilaian
        function unlockGradingSection() {
            const section = document.getElementById('validation-section');
            section.classList.remove('opacity-75'); // Hapus efek transparan
            
            // Aktifkan Input Nilai
            document.getElementById('student-predikat').disabled = false;
            document.getElementById('student-nilai').disabled = false;
            
            // Ubah Div Catatan jadi Textarea agar bisa diedit
            const catDiv = document.getElementById('student-catatan');
            if (catDiv.tagName === 'DIV') {
                const textArea = document.createElement('textarea');
                textArea.id = 'student-catatan';
                textArea.className = 'w-full border-b border-gray-300 bg-white p-2 text-xs h-20 resize-none outline-none focus:border-blue-500';
                textArea.placeholder = 'Tulis catatan evaluasi untuk siswa...';
                catDiv.parentNode.replaceChild(textArea, catDiv);
            }

            // Tampilkan Canvas TTD Guru
            document.getElementById('teacher-sig-placeholder').style.display = 'none';
            const canvasGuru = document.getElementById('sig-guru');
            canvasGuru.style.display = 'block';
            
            // Re-setup canvas agar ukurannya benar saat muncul
            setupSig('sig-guru');
            
            // Ubah Badge
            document.getElementById('score-badge').classList.replace('bg-gray-500', 'bg-blue-600');
            document.getElementById('score-badge').innerText = "MODE PENILAIAN AKTIF";
            document.getElementById('score-card').classList.replace('bg-gray-50', 'bg-blue-50');
            document.getElementById('score-card').classList.replace('border-gray-200', 'border-blue-300');
        }
    </script>
</head>
<body class="py-8 px-4 min-h-screen relative">

    <!-- TOMBOL AKSES GURU -->
    <button onclick="openLoginModal()" id="btn-login" class="fixed top-4 right-4 z-[50] bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg text-xs font-bold uppercase tracking-wider hover:bg-slate-700 hover:scale-105 transition-all no-print flex items-center gap-2 border border-slate-600 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Akses Guru
    </button>

    <!-- STATUS BAR SISWA (Real-time Feedback) -->
    <div id="student-status-bar" class="hidden fixed bottom-0 left-0 right-0 bg-yellow-100 border-t-4 border-yellow-500 p-4 z-[60] shadow-lg no-print slide-up">
        <div class="max-w-5xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="status-icon" class="animate-spin text-yellow-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800 text-lg" id="status-title">Menunggu Penilaian Guru...</h3>
                    <p class="text-sm text-slate-600" id="status-desc">Mohon tunggu sebentar, jangan tutup halaman ini.</p>
                </div>
            </div>
            <!-- Tombol Cetak untuk Siswa (Muncul setelah dinilai) -->
            <button id="btn-print-report" onclick="window.print()" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-lg transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                CETAK LAPORAN (PDF)
            </button>
        </div>
    </div>

    <!-- MODAL LOGIN -->
    <div id="login-modal" class="hidden fixed inset-0 bg-slate-900/90 z-[100] flex items-center justify-center no-print backdrop-blur-sm transition-opacity">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs border-t-4 border-blue-600 animate-fade-in-down">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Verifikasi Guru</h3>
                <p class="text-xs text-slate-500">Masukkan PIN untuk membuka kontrol.</p>
            </div>
            <input type="password" id="pin-input" class="w-full border-2 border-slate-200 rounded-lg p-2 text-center text-xl font-bold tracking-[0.5em] mb-4 focus:border-blue-500 focus:outline-none transition-colors" maxlength="6" placeholder="******">
            <div class="flex gap-2">
                <button onclick="closeLoginModal()" class="flex-1 py-2 rounded-lg border border-slate-200 text-slate-600 text-sm font-semibold hover:bg-slate-50 transition">Batal</button>
                <button onclick="checkPin()" class="flex-1 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition shadow-md">Masuk</button>
            </div>
        </div>
    </div>

    <!-- MODAL DASHBOARD DATA & GRADING -->
    <div id="dashboard-modal" class="hidden fixed inset-0 bg-slate-900/95 z-[200] flex flex-col p-2 md:p-6 no-print overflow-hidden backdrop-blur-md">
        <div class="bg-white w-full h-full rounded-xl shadow-2xl flex flex-col overflow-hidden relative">
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>
                    <div><h2 class="font-bold text-lg">Dashboard Data & Penilaian</h2><p class="text-xs text-slate-400" id="status-db">Memuat data...</p></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span class="hidden md:inline">Download Excel</span>
                    </button>
                    <button onclick="closeDashboard()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-bold">Tutup</button>
                </div>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div id="student-list-container" class="w-full md:w-1/2 lg:w-2/3 overflow-auto p-4 bg-slate-50 border-r border-slate-200">
                    <table class="w-full text-sm text-left text-slate-600 border-collapse">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-200 sticky top-0">
                            <tr><th class="px-4 py-3 rounded-tl-lg">Kelas & Nama</th><th class="px-4 py-3">Pertemuan</th><th class="px-4 py-3 text-center">Status</th><th class="px-4 py-3 text-center rounded-tr-lg">Aksi</th></tr>
                        </thead>
                        <tbody id="dashboard-body" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                <div id="grading-panel" class="hidden md:flex w-full md:w-1/2 lg:w-1/3 flex-col bg-white border-l border-slate-200 overflow-hidden relative">
                    <div class="p-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">üìù Form Penilaian Guru</h3>
                        <button onclick="closeGradingPanel()" class="md:hidden text-slate-500 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-6" id="grading-content"><div class="text-center text-slate-400 mt-10"><p>Pilih siswa dari daftar di sebelah kiri untuk mulai menilai.</p></div></div>
                    
                    <!-- TOMBOL AKSI GURU (CETAK & UPLOAD) -->
                    <div id="grading-actions" class="p-4 bg-white border-t border-slate-200 hidden flex-col gap-2">
                        <button onclick="printStudentFromDashboard()" class="w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 rounded flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                            Cetak / Preview PDF
                        </button>
                        <button onclick="uploadToDriveFromDashboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            Upload ke Drive Kelas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="max-w-[210mm] mx-auto container space-y-6">
        <div id="teacher-panel" class="hidden bg-slate-800 text-white p-4 rounded-lg shadow-xl no-print flex flex-col md:flex-row items-center justify-between gap-4 border-l-4 border-blue-400">
            <div><h2 class="font-bold text-base text-blue-300 flex items-center gap-2"><span>üéõÔ∏è</span> KONTROL MATERI</h2><p class="text-[10px] text-slate-400 mt-1">Mode Guru Aktif ‚Ä¢ Pilih Pertemuan untuk update LKPD</p></div>
            <div class="flex flex-col sm:flex-row items-center gap-2 w-full md:w-auto">
                <select id="meetingSelector" onchange="loadMeetingData()" class="bg-slate-700 border border-slate-600 text-white text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                    <option value="1">Pertemuan 1: Lari Jarak Pendek (Sprint)</option>
                    <option value="2">Pertemuan 2: Lari Jarak Menengah</option>
                    <option value="3">Pertemuan 3: Lari Jarak Jauh (Endurance)</option>
                </select>
                <button onclick="openDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-4 py-2.5 rounded font-bold transition w-full sm:w-auto flex items-center gap-2">üìÇ Dashboard & Penilaian</button>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-2.5 rounded font-bold transition w-full sm:w-auto">Keluar</button>
            </div>
        </div>

        <div class="bg-white shadow-2xl rounded-sm overflow-hidden border border-slate-200 main-card relative min-h-[297mm]">
            <div class="p-8 border-b-2 border-slate-800 relative text-center">
                <div class="hidden md:flex absolute top-6 left-8 w-16 h-16 bg-white border-2 border-slate-800 rounded items-center justify-center text-[10px] text-slate-800 font-black leading-tight text-center">LOGO<br>SEKOLAH</div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tight uppercase mb-1">LKPD & PORTOFOLIO SISWA</h1>
                <h2 class="text-sm font-bold text-slate-600 uppercase tracking-[0.2em] mb-4">Pendidikan Jasmani, Olahraga, dan Kesehatan</h2>
                <div class="inline-flex gap-0 text-xs font-semibold border border-slate-300 rounded overflow-hidden"><span class="bg-slate-100 text-slate-600 px-4 py-1.5 border-r border-slate-300">Fase E (Kelas X)</span><span class="bg-white text-blue-700 px-4 py-1.5 uppercase">Materi Pokok: Lari (Jarak Pendek s.d. Jauh)</span></div>
            </div>

            <div class="p-8 md:p-10 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start gap-8 border-b-2 border-dashed border-slate-300 pb-6 avoid-break">
                    <div class="w-full md:w-2/3 identity-grid text-sm">
                        <label class="font-bold text-slate-700 uppercase">Kelas</label><div class="font-bold">:</div>
                        <select id="class-select" onchange="loadStudents()" class="w-full border-b border-slate-400 outline-none px-1 py-0.5 bg-blue-50/50 focus:bg-blue-100 font-semibold cursor-pointer"><option value="">-- Pilih Kelas --</option><option value="X TKJ A">X TKJ A</option><option value="X TKJ B">X TKJ B</option><option value="X TBSM">X TBSM</option></select>
                        <label class="font-bold text-slate-700 uppercase">Nama Siswa</label><div class="font-bold">:</div>
                        <select id="student-select" onchange="updateAbsen()" class="w-full border-b border-slate-400 outline-none px-1 py-0.5 bg-blue-50/50 focus:bg-blue-100 font-semibold cursor-pointer"><option value="">-- Pilih Nama Siswa --</option></select>
                        <label class="font-bold text-slate-700 uppercase">No. Absen</label><div class="font-bold">:</div>
                        <input type="text" id="absen-input" class="w-full border-b border-slate-400 outline-none px-1 py-0.5 bg-gray-100 text-slate-500 font-mono" readonly placeholder="Otomatis terisi...">
                        <label class="font-bold text-slate-700 uppercase">Tanggal</label><div class="font-bold">:</div>
                        <input type="date" id="student-date" class="w-full border-b border-slate-400 outline-none px-1 py-0.5 bg-blue-50/50 uppercase text-slate-700 font-mono">
                    </div>
                    <div class="w-full md:w-1/3 bg-slate-50 p-4 border border-slate-200 rounded text-center"><p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">Fokus Materi</p><p id="display-meeting-title" class="text-sm font-bold text-blue-700 leading-tight">Pertemuan 1</p></div>
                </div>

                <section class="avoid-break">
                    <h3 class="font-bold text-slate-900 mb-2 text-sm uppercase flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 flex items-center justify-center rounded text-xs">I</span>Ringkasan Materi (Poin Penting)</h3>
                    <div id="content-materi" class="bg-slate-50 p-4 rounded border-l-4 border-slate-300 text-xs text-slate-700 leading-relaxed text-justify space-y-2"></div>
                </section>

                <section class="avoid-break">
                    <h3 class="font-bold text-slate-900 mb-2 text-sm uppercase flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 flex items-center justify-center rounded text-xs">II</span>Kartu Tugas Gerak</h3>
                    <p class="text-xs text-slate-500 italic mb-3 ml-8">Lakukan aktivitas berikut dan beri tanda centang jika berhasil:</p>
                    <div id="content-aktivitas" class="grid grid-cols-1 md:grid-cols-2 gap-3 pl-2 md:pl-8"></div>
                </section>

                <section class="avoid-break">
                    <h3 class="font-bold text-slate-900 mb-2 text-sm uppercase flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 flex items-center justify-center rounded text-xs">III</span>Refleksi & Pemahaman</h3>
                    <div id="content-soal" class="space-y-4 pl-2 md:pl-8"></div>
                </section>

                <section class="avoid-break">
                    <h3 class="font-bold text-slate-900 mb-2 text-sm uppercase flex items-center gap-2"><span class="bg-slate-800 text-white w-6 h-6 flex items-center justify-center rounded text-xs">IV</span>Penilaian Sikap (Profil Pelajar Pancasila)</h3>
                    <div class="pl-0 md:pl-8">
                        <table class="w-full text-xs border border-slate-300">
                            <thead class="bg-slate-100 font-bold uppercase text-slate-700"><tr><th class="p-2 border border-slate-300 w-8">No</th><th class="p-2 border border-slate-300 text-left">Indikator Perilaku</th><th class="p-2 border border-slate-300 w-12 text-center">Ya</th><th class="p-2 border border-slate-300 w-12 text-center">Tdk</th></tr></thead>
                            <tbody class="text-slate-800" id="checklist-sikap-body"></tbody>
                        </table>
                    </div>
                </section>

                <section class="mt-8 pt-4 border-t-2 border-slate-800 flex flex-col md:flex-row justify-between gap-6 avoid-break opacity-75 transition-opacity duration-500" id="validation-section">
                    <div class="flex-1 bg-gray-50 border border-gray-200 p-4 rounded relative" id="score-card">
                        <div class="absolute -top-3 left-3 bg-gray-500 text-white px-2 py-0.5 text-[10px] font-bold uppercase rounded" id="score-badge">Diisi Guru (Terkunci)</div>
                        <div class="flex gap-4 mb-3 mt-1">
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Predikat</label><input type="text" id="student-predikat" disabled placeholder="-" class="w-full border-b border-gray-300 bg-transparent text-sm font-bold text-gray-800"></div>
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Nilai</label><input type="text" id="student-nilai" disabled placeholder="-" class="w-full border-b border-gray-300 bg-transparent text-sm font-bold text-gray-800 text-center"></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Catatan Evaluasi</label><div id="student-catatan" class="w-full border-b border-gray-300 p-2 text-xs h-12 text-gray-400 italic">Menunggu penilaian guru...</div></div>
                    </div>
                    <div class="flex gap-4 justify-end">
                        <div class="text-center w-32"><p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Siswa</p><canvas id="sig-siswa" class="signature-pad w-32 h-20 bg-white border-2 border-dashed border-slate-300 rounded hover:border-slate-400 transition-colors"></canvas><button onclick="clearSig('sig-siswa')" id="btn-clear-sig" class="no-print text-[10px] text-red-500 hover:text-red-700 font-bold mt-1">Hapus / Ulang</button></div>
                        <div class="text-center w-32">
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Guru Mapel</p>
                            <!-- TTD PLACEHOLDER (DEFAULT) -->
                            <div id="teacher-sig-placeholder" class="w-32 h-20 bg-gray-50 border border-gray-200 rounded flex items-center justify-center text-xs text-gray-300 italic">TTD Guru</div>
                            <!-- TTD CANVAS (HIDDEN INITIALLY) -->
                            <canvas id="sig-guru" class="signature-pad w-32 h-20 bg-white border-2 border-dashed border-slate-300 rounded hover:border-slate-400 transition-colors hidden"></canvas>
                            <button onclick="clearSig('sig-guru')" id="btn-clear-teacher-sig" class="no-print text-[10px] text-red-500 hover:text-red-700 font-bold mt-1 hidden">Hapus</button>
                            <p class="text-[10px] font-bold mt-1 text-slate-800">M. Nanda S.N., S.Kom.</p>
                        </div>
                    </div>
                </section>

                <div class="no-print pt-6 pb-20 space-y-3">
                    <button onclick="window.print()" class="w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg> üñ®Ô∏è SIMPAN SEBAGAI PDF (UNTUK ORTU)
                    </button>
                    <button id="btn-submit-lkpd" onclick="saveStudentData()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg> UNGGAH KE GOOGLE DRIVE
                    </button>
                    <p class="text-center text-xs text-slate-400" id="submit-hint">Simpan PDF terlebih dahulu, lalu unggah ke Drive Guru.</p>
                </div>
            </div>
        </div>
        <p class="text-center text-slate-400 text-[10px] mt-4 mb-8 no-print">&copy; 2026 Platform Merdeka Mengajar - Modul PJOK</p>
    </div>

    <!-- MAIN DATA SCRIPT -->
    <script>
        document.getElementById('pin-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkPin();
        });

        // DATA SISWA
        const studentData = {
            "X TKJ A": ["ALDO BARETO", "DARMA YANTI", "DIRLY REVA RADITYA", "FAIZ FATAH HILLAH", "FIRMANSYAH ARDIANTO", "GEDE ARYA DEVA NANDA", "I GEDE JAYA SATRIA", "IDA AYU PUTU GITA NIRAWATI", "KOMANG RENDI KAJENG PRATAMA", "LUTVIA ANAS TASYA", "MADE AYU BUDIATI", "MUHAMAD LABIB MIRZA", "NABILA NUR HAFIFAH", "NI KETUT DESTA LESTARI", "RAFLY MEY WILIAN", "RIFAI ARYA MAULANA", "SEVA WISNU RAMADHAN", "SHEILLA NIKI DESTIANI", "TYAN FAJAR PRASETYO", "ZIVARA APRILIA"],
            "X TKJ B": ["ANISA", "CLARA SALSABILA", "FEBRIAN RIZKI VALENTINO", "GUSTI AYU KOMANG VYA KARTINI", "I KOMANG ARNAWAN WIGUNA", "I MADE GILANG PURNAJAYA", "I WAYAN TEGAR WALOYO", "IDA AYU SINDI SINTYAWATI", "KOMANG RAFA DINATA", "KOMANG REDITE", "MADE EDI PURWATE", "NI KADEK ARTIKA CHANDRA DEWI", "NI LUH MERY ARYAWATI", "NYOMAN TRI APSARI WIDIA", "PANDE KETUT BAGAS KARA", "PUTU FITRI YANI", "REHAN OGI DWI PRANATA", "RIZELENEY APRILIA", "SYIFA ADELIA CAHYANI", "WAYAN SUDIARTE"],
            "X TBSM": ["ABBEL DANU VIAN", "AHMAD FAHRI MUSTOFA", "ALDI MIFTAKHUL JINAN", "ALDO VIRMANSYAH", "ARYA AL FAIS", "DENIS LUTVI AZIZ", "DEWA GEDE WISNU SATRIAWAN", "EDO JAYA PRATAMA", "EXSAN BAYU NUGEROHO", "FADLI ILHAM ABDILLAH", "FILLPUS AL FINO", "I DEWA GEDE ADITYA SAPUTRA", "MUHAMAD ALDO SAPUTRA", "MUHAMMAD FAJRI KATAMI", "MUSTOFA", "NANDA WIJAYA", "RADIT PRASTYO", "RAYHAN PRATAMA", "REFAN ALDIANO", "RENDY SETIAWAN", "RENO AVIAN", "REZA PRASTOMI", "RISJAYA PRATAMA", "YUSUF APRIL ERLANGGA", "WAYAN ANDIKA"]
        };

        const driveLinks = {
            "X TKJ A": "https://drive.google.com/drive/folders/1b2Mg_YHYij2O37oALZjg852woYsCpyFP?usp=drive_link",
            "X TKJ B": "https://drive.google.com/drive/folders/1p6J-WpOSDDFhtOH1H4OiDNCzNbZA2TkP?usp=drive_link",
            "X TBSM": "https://drive.google.com/drive/folders/1CCl5Jc7RJW8GdgEERaoOnIA-X7-AyXwd?usp=drive_link"
        };

        const sikapList = [
            { title: "Beriman & Bertakwa", desc: "Menjaga sopan santun dan tidak berkata kasar saat merasa lelah atau emosi." },
            { title: "Mandiri", desc: "Tidak banyak mengeluh dan berusaha menyelesaikan tugas lari sesuai kemampuan sendiri." },
            { title: "Gotong Royong", desc: "Memberi semangat (support) kepada teman yang tertinggal atau kesulitan saat lari." },
            { title: "Bernalar Kritis", desc: "Berani bertanya jika belum paham teknik atau mampu menjawab pertanyaan guru." },
            { title: "Kreatif", desc: "Mencari solusi sederhana saat latihan (misal: mengatur napas sendiri agar tidak cepat capek)." }
        ];

        window.loadStudents = function() {
            const classSelect = document.getElementById('class-select');
            const studentSelect = document.getElementById('student-select');
            const selectedClass = classSelect.value;
            studentSelect.innerHTML = '<option value="">-- Pilih Nama Siswa --</option>';
            document.getElementById('absen-input').value = "";
            if (selectedClass && studentData[selectedClass]) {
                studentData[selectedClass].forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.text = name;
                    studentSelect.appendChild(option);
                });
            }
        }

        window.updateAbsen = function() {
            const studentSelect = document.getElementById('student-select');
            const absenInput = document.getElementById('absen-input');
            if (studentSelect.value) absenInput.value = studentSelect.value;
            else absenInput.value = "";
        }

        const rppData = {
            1: {
                title: "Pertemuan 1: Lari Jarak Pendek (Sprint)",
                materi: `<div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">1. Sejarah & Organisasi</strong><p class="mb-2">Atletik disebut sebagai <em>"Mother of Sports"</em> (Induk Cabang Olahraga) karena menjadi fondasi gerakan dasar seperti lari, lompat, dan lempar. Induk organisasi internasionalnya adalah <strong>World Athletics</strong>, sedangkan di Indonesia adalah <strong>PASI</strong> (Persatuan Atletik Seluruh Indonesia).</p></div><div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">2. Teknik Start Jongkok (Crouch Start)</strong><p class="mb-2">Teknik start yang efektif menggunakan tumpuan yang kuat untuk menghasilkan dorongan maksimal.</p><ul class="list-disc ml-4 space-y-1 mt-1"><li><strong>"Bersedia":</strong> Posisi jongkok, tangan membentuk huruf V terbalik di belakang garis start. Lutut kaki belakang menyentuh permukaan lintasan.</li><li><strong>"Siap":</strong> Angkat <strong>panggul</strong> sedikit lebih tinggi dari bahu. Pindahkan pusat berat badan ke depan (bertumpu pada lengan) untuk persiapan tolakan.</li><li><strong>"Ya":</strong> Lakukan <strong>tolakan eksplosif</strong> kaki belakang pada tumpuan agar tubuh meluncur cepat ke depan dengan sudut kemiringan yang tepat.</li></ul></div><div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">3. Biomekanika Lari Sprint</strong><p>Saat melakukan sprint, tubuh condong ke depan (body lean). Tumpuan kaki menggunakan <strong>ujung telapak kaki (forefoot)</strong> untuk meminimalkan waktu kontak dengan tanah dan memaksimalkan dorongan. Ayunan lengan siku ditekuk 90 derajat secara kuat.</p></div>`,
                aktivitas: [
                    { title: "Praktik Posisi Tangan", desc: "Melatih posisi tangan V-terbalik di garis start. Memastikan jari-jari kokoh menopang beban tubuh untuk stabilitas." },
                    { title: "Latihan Reaksi (Reaction Drill)", desc: "Berdiri membelakangi instruktur. Saat mendengar sinyal suara, segera berbalik dan melakukan akselerasi 5-10 meter." },
                    { title: "Sprint 30 Meter", desc: "Melakukan lari 30 meter. Fokus pada transisi posisi tubuh dari condong (fase akselerasi) ke posisi lari tegak." },
                    { title: "Teknik Memasuki Garis Finish", desc: "Berlari melewati garis finish dengan membusungkan dada (The Dip) tanpa mengurangi kecepatan secara tiba-tiba." }
                ],
                soal: [
                    "Apa yang paling sulit kamu rasakan saat melakukan start jongkok tadi? Apakah kakimu terasa licin atau kuat menolak?",
                    "Saat lari kencang tadi, apakah kamu lari jinjit (ujung kaki) atau telapak rata? Mana yang menurutmu membuat larimu lebih cepat?",
                    "Saat aba-aba 'Siap' (panggul naik), apakah tanganmu terasa gemetar menahan berat badan? Ceritakan apa yang kamu rasakan di lenganmu!"
                ]
            },
            2: {
                title: "Pertemuan 2: Lari Jarak Menengah (800m - 1500m)",
                materi: `<div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">1. Sejarah & Karakteristik Lari Menengah</strong><p class="mb-2">Nomor lari 800m dan 1500m memiliki sejarah panjang sejak Olimpiade Kuno. Nomor ini unik karena menuntut perpaduan dua aspek fisik utama: <strong>Kecepatan</strong> (seperti sprinter) dan <strong>Daya Tahan</strong> (seperti pelari maraton). Pelari harus cerdas menghemat tenaga (efisiensi) di awal, namun memiliki sisa tenaga untuk sprint di akhir.</p></div><div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">2. Analisis Teknik & Posisi Tubuh</strong><p class="mb-2">Berbeda dengan sprinter yang membungkuk, pelari jarak menengah menggunakan <strong>Start Berdiri (Standing Start)</strong> dengan posisi tubuh lebih tegak (sekitar 80-85 derajat). Posisi tegak ini penting untuk membuka rongga dada agar asupan oksigen ke paru-paru lebih maksimal selama berlari.</p></div><div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">3. Strategi Lomba (Taktik)</strong><ul class="list-disc ml-4 space-y-1"><li><strong>Pacing (Pengaturan Irama):</strong> Menjaga kecepatan tetap stabil (konstan) di setiap putaran agar tidak kelelahan dini.</li><li><strong>Positioning:</strong> Menjaga posisi agar tidak terkurung lawan, terutama saat memasuki tikungan.</li><li><strong>Kick:</strong> Kemampuan melakukan akselerasi maksimal di 100-200 meter terakhir menjelang finish.</li></ul></div>`,
                aktivitas: [
                    { title: "Simulasi Start Berdiri", desc: "Mempraktikkan posisi kaki (satu depan, satu belakang) dengan lutut sedikit ditekuk dan badan condong." },
                    { title: "Teknik Pendaratan (Midfoot)", desc: "Jogging ritmis dengan fokus pendaratan kaki rata. Membandingkan efisiensinya dengan teknik jinjit." },
                    { title: "Latihan Pacing", desc: "Berlari dengan target waktu putaran yang konsisten (misal: 2 menit per putaran) untuk melatih 'feeling' irama." },
                    { title: "Manajemen Pernapasan", desc: "Berlari dengan pola napas ritmis 2:2 (2 langkah inhalasi, 2 langkah ekshalasi)." }
                ],
                soal: [
                    "Apa bedanya rasa capek saat lari sprint (Pertemuan 1) dengan lari keliling lapangan hari ini? Mana yang lebih bikin napasmu 'ngos-ngosan'?",
                    "Apakah perutmu terasa sakit (suduk) atau napasmu sesak saat berlari tadi? Jika iya, apa yang kamu lakukan biar enakan?",
                    "Coba bayangkan jika kamu lari secepat kilat (sprint) di awal start tadi, kira-kira apa yang akan terjadi pada kakimu di putaran terakhir? Masih kuat atau lemas?"
                ]
            },
            3: {
                title: "Pertemuan 3: Lari Jarak Jauh (Endurance)",
                materi: `<div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">1. Sejarah & Filosofi Marathon</strong><p class="mb-2">Lari jarak jauh memiliki akar sejarah dari legenda Marathon (Yunani Kuno). Ini merupakan uji ketahanan fisik dan mental manusia yang ekstrem.</p><div class="grid grid-cols-1 gap-1 text-[10px] bg-slate-50 p-2 rounded mb-2"><p><strong>Fartlek (Speed Play):</strong> Metode latihan variasi kecepatan (lari, jogging, jalan) di medan alami.</p><p><strong>Personal Best (PB):</strong> Catatan waktu terbaik pribadi yang menjadi tolok ukur kemajuan atlet.</p></div></div><div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">2. Konsep Daya Tahan (Endurance)</strong><p>Kunci lari jarak jauh adalah efisiensi energi. Ayunan lengan rendah dan rileks. Frekuensi langkah (cadence) dijaga stabil untuk menghemat konsumsi oksigen.</p></div><div class="mb-4"><strong class="text-blue-800 block mb-1 text-sm border-b border-blue-200 pb-1">3. Fenomena Kelelahan</strong><p>Pelari jarak jauh sering menghadapi fase <em>"Hitting the Wall"</em>, yaitu kondisi kehabisan cadangan glikogen otot secara drastis. Diperlukan strategi mental dan hidrasi yang tepat untuk mengatasinya.</p></div>`,
                aktivitas: [
                    { title: "Latihan Fartlek", desc: "Berlari durasi 15 menit dengan variasi intensitas: Sprint, Jogging, dan Jalan secara bergantian." },
                    { title: "Uji Daya Tahan (Tes Cooper)", desc: "Berlari sejauh mungkin dalam waktu 12 menit untuk mengukur kapasitas aerobik (VO2 Max)." },
                    { title: "Pemulihan Denyut Nadi", desc: "Mengukur denyut nadi pemulihan (recovery heart rate) untuk menilai tingkat kebugaran jantung." },
                    { title: "Pendinginan (Cooling Down)", desc: "Melakukan peregangan statis pada otot tungkai untuk mencegah kram otot." }
                ],
                soal: [
                    "Bagian tubuh mana yang paling pegal saat lari jarak jauh tadi? Kaki, napas, atau pundak? Ceritakan rasanya!",
                    "Apa yang kamu pikirkan saat merasa sangat capek tapi harus tetap lari? Kalimat apa yang kamu ucapkan dalam hati biar semangat lagi?",
                    "Mana yang lebih asik menurutmu: Lari terus-menerus dengan kecepatan sama, atau lari Fartlek (lari-jalan-lari) yang berubah-ubah? Kenapa?"
                ]
            }
        };

        window.loadMeetingData = function() {
            const id = document.getElementById('meetingSelector').value;
            const data = rppData[id];
            document.getElementById('display-meeting-title').innerText = data.title;
            document.getElementById('content-materi').innerHTML = data.materi;

            const actContainer = document.getElementById('content-aktivitas');
            actContainer.innerHTML = '';
            data.aktivitas.forEach((act, idx) => {
                actContainer.innerHTML += `
                    <div class="bg-white border border-slate-200 p-3 rounded shadow-sm flex items-start gap-3">
                        <input type="checkbox" class="mt-1 custom-checkbox shrink-0">
                        <div>
                            <h4 class="font-bold text-xs text-slate-800">${act.title}</h4>
                            <p class="text-[10px] text-slate-500 leading-tight mt-0.5">${act.desc}</p>
                        </div>
                    </div>
                `;
            });

            const soalContainer = document.getElementById('content-soal');
            soalContainer.innerHTML = '';
            data.soal.forEach((soal, idx) => {
                soalContainer.innerHTML += `
                    <div class="relative">
                        <label class="font-bold text-xs text-slate-800 block mb-1">${idx + 1}. ${soal}</label>
                        <textarea class="w-full border-b border-dashed border-slate-300 bg-transparent outline-none text-xs py-1 focus:bg-blue-50 transition-colors resize-none overflow-hidden" rows="2" placeholder="Jawaban: ................................................................................."></textarea>
                    </div>
                `;
            });
        }

        window.logout = function() {
            document.getElementById('teacher-panel').classList.add('hidden');
            document.getElementById('btn-login').classList.remove('hidden');
            document.getElementById('meetingSelector').value = "1";
            loadMeetingData();
        }

        // Tanda Tangan
        function setupSig(id) {
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let drawing = false;
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
            }
            setTimeout(resizeCanvas, 100);
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - rect.left,
                    y: (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - rect.top
                };
            }
            const start = (e) => { drawing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); if(e.type==='touchstart') e.preventDefault(); };
            const move = (e) => { if(!drawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); if(e.type==='touchmove') e.preventDefault(); };
            const end = () => drawing = false;
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseleave', end);
            canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        }
        
        window.clearSig = function(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.restore(); ctx.beginPath();
        }

        window.addEventListener('load', () => {
            document.getElementById('student-date').valueAsDate = new Date();
            loadMeetingData();
            setupSig('sig-siswa');
            
            // Inisialisasi Checklist
            const checklistBody = document.getElementById('checklist-sikap-body');
            if (checklistBody) {
                checklistBody.innerHTML = '';
                sikapList.forEach((item, idx) => {
                    const bgClass = idx % 2 === 0 ? '' : 'bg-slate-50';
                    checklistBody.innerHTML += `
                        <tr class="${bgClass}">
                            <td class="p-2 border border-slate-300 text-center font-bold">${idx + 1}</td>
                            <td class="p-2 border border-slate-300">
                                <strong>${item.title}:</strong> ${item.desc}
                            </td>
                            <td class="p-2 border border-slate-300 text-center"><input type="checkbox" class="custom-checkbox"></td>
                            <td class="p-2 border border-slate-300 text-center"><input type="checkbox" class="custom-checkbox"></td>
                        </tr>
                    `;
                });
            }
        });
    </script>

    <!-- Firebase Module Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG FIREBASE OTOMATIS (DUAL MODE)
        let app, auth, db, currentUser;
        let collectionPath;
        let selectedStudentClass = null; 

        try {
            // Mode 1: Editor Canvas (Internal)
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                collectionPath = `artifacts/${appId}/public/data/lkpd_submissions`;

                // Auth Internal
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
            }
        } catch (e) {
            console.log("Switching to External Config...");
        }

        // Mode 2: External Hosting (GitHub Pages) - Fallback jika mode 1 gagal
        if (!app) {
            const firebaseConfig = {
                apiKey: "AIzaSyC-FFct17BVAdsqii9DOuAQLZnGF25fzOA",
                authDomain: "lkpd-pjok-smk.firebaseapp.com",
                projectId: "lkpd-pjok-smk",
                storageBucket: "lkpd-pjok-smk.firebasestorage.app",
                messagingSenderId: "1006297448814",
                appId: "1:1006297448814:web:987593ba4365f4b5a7c17f"
            };
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            collectionPath = 'lkpd_submissions'; // Root path

            signInAnonymously(auth).catch(console.error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("DB Connected.");
            }
        });

        // --- GLOBAL WINDOW FUNCTIONS ---
        
        window.saveStudentData = async function() {
            // 1. Validasi Input
            const kelas = document.getElementById('class-select').value;
            const studentSelect = document.getElementById('student-select');
            const nama = studentSelect.options[studentSelect.selectedIndex]?.text;
            const tgl = document.getElementById('student-date').value;

            if (!kelas || !studentSelect.value || !tgl) {
                alert("Harap lengkapi Nama, Kelas, dan Tanggal!");
                return;
            }

            // 2. LOGIKA UPLOAD DRIVE SESUAI KELAS
            const driveLinks = {
                "X TKJ A": "https://drive.google.com/drive/folders/1b2Mg_YHYij2O37oALZjg852woYsCpyFP?usp=drive_link",
                "X TKJ B": "https://drive.google.com/drive/folders/1p6J-WpOSDDFhtOH1H4OiDNCzNbZA2TkP?usp=drive_link",
                "X TBSM": "https://drive.google.com/drive/folders/1CCl5Jc7RJW8GdgEERaoOnIA-X7-AyXwd?usp=drive_link"
            };
            
            const targetLink = driveLinks[kelas];
            
            if (targetLink) {
                 // Buka Drive di tab baru
                 window.open(targetLink, '_blank');
            } else {
                alert("Link Drive untuk kelas ini belum diatur. Silakan lapor ke Guru.");
                return;
            }
            
            // 3. (Opsional) Simpan log ke database agar Guru tahu siapa yang "klik" kumpul
            if (currentUser) {
                try {
                     const pertemuan = document.getElementById('meetingSelector').options[document.getElementById('meetingSelector').selectedIndex].text;
                     const submissionData = {
                        kelas, nama, no_absen: studentSelect.value, tanggal: tgl, pertemuan,
                        status: "Diunggah ke Drive", timestamp: Timestamp.now()
                     };
                     await addDoc(collection(db, collectionPath), submissionData);
                } catch(e) { console.log("Log saved locally only"); }
            }
        };
        
        // --- DASHBOARD GURU LOGIC ---
        let loadedSubmissions = [];
        window.openDashboard = function() {
            if(!currentUser) return;
            document.getElementById('dashboard-modal').classList.remove('hidden');
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center">Loading...</td></tr>';
            
            onSnapshot(collection(db, collectionPath), (snap) => {
                loadedSubmissions = [];
                snap.forEach(d => {
                    let item = d.data();
                    item.id = d.id;
                    loadedSubmissions.push(item);
                });
                loadedSubmissions.sort((a,b) => a.kelas.localeCompare(b.kelas));
                window.cachedSubmissions = loadedSubmissions;
                renderList(loadedSubmissions);
            });
        };

        function renderList(data) {
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = '';
            data.forEach(sub => {
                const color = sub.status === "Sudah Dinilai" ? "text-green-600 bg-green-100" : "text-amber-600 bg-amber-100";
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer border-b" onclick="openGradingPanel('${sub.id}')">
                        <td class="px-4 py-3"><b>${sub.nama}</b><div class="text-xs text-slate-500">${sub.kelas}</div></td>
                        <td class="px-4 py-3 text-xs">${sub.pertemuan}</td>
                        <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold ${color}">${sub.status}</span></td>
                        <td class="px-4 py-3 text-center"><button class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs">Nilai</button></td>
                    </tr>
                `;
            });
        }

        window.openGradingPanel = function(id) {
            const sub = loadedSubmissions.find(s => s.id === id);
            if(!sub) return;
            
            selectedStudentClass = sub.kelas; // Store class for drive upload logic
            
            document.getElementById('grading-panel').classList.remove('hidden');
            document.getElementById('grading-panel').classList.add('flex');
            document.getElementById('grading-actions').classList.remove('hidden');
            document.getElementById('grading-actions').classList.add('flex'); // Show buttons
            
            let ansHtml = sub.jawaban_refleksi ? sub.jawaban_refleksi.map((a,i) => `<div class="bg-slate-50 p-2 border mb-2 text-xs"><b>Jawab ${i+1}:</b> ${a}</div>`).join('') : '';
            
            document.getElementById('grading-content').innerHTML = `
                <h3 class="font-bold">${sub.nama}</h3>
                <p class="text-xs text-slate-500 mb-4">${sub.kelas}</p>
                <div class="mb-4">${ansHtml}</div>
                <div class="space-y-2">
                   <input type="number" id="grade-val" value="${sub.nilai!='-'?sub.nilai:''}" placeholder="Nilai" class="w-full border p-2 text-sm">
                   <select id="grade-pred" class="w-full border p-2 text-sm">
                       <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                   </select>
                   <textarea id="grade-note" class="w-full border p-2 text-sm" placeholder="Catatan...">${sub.catatan!='-'?sub.catatan:''}</textarea>
                   <button onclick="submitGrade('${sub.id}')" class="w-full bg-blue-600 text-white p-2 rounded">Simpan</button>
                </div>
            `;
        }

        window.submitGrade = async function(id) {
             const val = document.getElementById('grade-val').value;
             const pred = document.getElementById('grade-pred').value;
             const note = document.getElementById('grade-note').value;
             if(!val) return alert("Isi nilai!");
             
             await updateDoc(doc(db, collectionPath, id), {
                 nilai: val, predikat: pred, catatan: note, status: "Sudah Dinilai"
             });
             alert("Tersimpan!");
        }
        
        // --- NEW DASHBOARD ACTION FUNCTIONS ---
        
        window.printStudentFromDashboard = function() {
             document.getElementById('dashboard-modal').classList.add('hidden');
             setTimeout(() => {
                 window.print();
             }, 500);
        }

        window.uploadToDriveFromDashboard = function() {
            if (!selectedStudentClass) {
                alert("Pilih siswa terlebih dahulu!");
                return;
            }
            
            const driveLinks = {
                "X TKJ A": "https://drive.google.com/drive/folders/1b2Mg_YHYij2O37oALZjg852woYsCpyFP?usp=drive_link",
                "X TKJ B": "https://drive.google.com/drive/folders/1p6J-WpOSDDFhtOH1H4OiDNCzNbZA2TkP?usp=drive_link",
                "X TBSM": "https://drive.google.com/drive/folders/1CCl5Jc7RJW8GdgEERaoOnIA-X7-AyXwd?usp=drive_link"
            };
            
            const targetLink = driveLinks[selectedStudentClass];
            if(targetLink) {
                window.open(targetLink, '_blank');
            } else {
                alert("Link Drive tidak ditemukan untuk kelas ini.");
            }
        }

        window.closeGradingPanel = () => {
            document.getElementById('grading-panel').classList.add('hidden');
            document.getElementById('grading-panel').classList.remove('flex');
        }
        window.closeDashboard = () => document.getElementById('dashboard-modal').classList.add('hidden');
        
        window.exportToCSV = function() {
             if (!window.cachedSubmissions) return;
             const rows = [["Nama", "Kelas", "Nilai", "Catatan"]];
             window.cachedSubmissions.forEach(s => rows.push([`"${s.nama}"`, s.kelas, s.nilai, `"${s.catatan}"`]));
             const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
             const link = document.createElement("a");
             link.setAttribute("href", encodeURI(csvContent));
             link.setAttribute("download", "nilai.csv");
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        }

    </script>
</body>
</html>


